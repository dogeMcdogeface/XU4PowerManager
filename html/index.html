<head>
    <!-- Load plotly.js into the DOM -->
    <script src='https://cdn.plot.ly/plotly-2.4.2.min.js'></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        .full-height {
            height: 100%;
            background: #383838;
        }
    </style>
</head>

<body>
<div class="full-height" , id='myDiv'><!-- Plotly chart will be drawn inside this DIV --></div>

<script>

    /************** CONFIGURATION ********************/

    var graph_color = "#232323";
    var bg_color = "#383838";
    var grid_color = '#383838';
    var text_color = '#ffffff';

    var fan_color = '#008aff';
    var gpu_color = '#ff00ff';
    var cpu_color = [
        'rgba(255,0,0,0.5)',
        'rgba(0,234,255,0.5)',
        'rgba(26,255,0,0.5)',
        'rgba(255,0,229,0.5)',
        'rgba(255,89,0,0.5)',
        'rgba(255,251,0,0.5)',
        'rgba(0,94,255,0.5)',
        'rgba(179,127,255,0.5)',

    ]


    /************** WORKING VARIABLES ****************/
    var autoScroll = true;
    /************** REQUEST HISTORY ******************/
    let requestHistory = new XMLHttpRequest();
    requestHistory.responseType = 'json';
    requestHistory.open('GET', window.location.href + "history");
    requestHistory.onload = function () {
        console.log(requestHistory.response)

        /************** PARSE HISTORY DATA ***************/
        var history = requestHistory.response

        if (history.includes(null)) {
            setTimeout(function () {
                location.reload();
            }, 1000);
            return;
        }

        history.sort((a, b) => new Date(a.Time).getTime() - new Date(b.Time).getTime());


        var flippedData = {};
        for (var key in history[0]) {
            if (flippedData[key] == null) flippedData[key] = [];
        }
        for (var row in history) {
            for (var key in history[row]) {
                flippedData[key][row] = parseInput(key, history[row]);
            }
        }

        var traces = [];

        var i = 0;
        for (var key in flippedData) {
            var ya;
            var cl;
            var mode = 'lines';

            if (key == "Time")
                continue;
            else if (key.includes("ThermalGpu")) {
                ya = 'y1';
                cl = gpu_color;
            } else if (key.includes("Thermal")) {
                ya = 'y1';
                cl = cpu_color[i%8];
            } else if (key.includes("FreqGpu")) {
                ya = 'y3';
                cl = gpu_color;
            } else if (key.includes("Freq")) {
                ya = 'y2';
                mode = 'hv'
                cl = cpu_color[i%8];
            } else if (key.includes("Fan")) {
                ya = 'y4';
                cl = fan_color;
            }

            traces[i++] = {
                name: key,
                y: flippedData[key],
                x: flippedData["Time"],
                yaxis: ya,
                mode: mode,
                //fill: 'tozeroy',//'tonexty',
                //stackgroup: 'one',
                line: {
                    dash: 'line',
                    color: cl,
                }
            }
        }

        console.log("flippedData", flippedData)
        console.log("traces", traces)

        var layout = {
            xaxis: {
                anchor: 'free',     //set below (Update)
                type: 'date',
                range: [-1, -1],
                domain: [0, 1]
            },
            /*********** SUBPLOT 1 ***************/
            yaxis: {
                title: {text: 'Core Temperatures'},
                type: 'number',
                ticksuffix: "Â°C",
                gridcolor: grid_color,
                range: [20, 100],
                domain: [0.76, 1]
            },
            /*********** SUBPLOT 2 ***************/
            yaxis2: {
                title: {text: 'Core Frequencies'},
                type: 'number',
                ticksuffix: "Ghz",
                gridcolor: grid_color,
                range: [0, 3],
                domain: [0.51, 0.74]
            },
            /*********** SUBPLOT 3 ***************/
            yaxis3: {
                title: {text: 'GPU Frequency'},
                type: 'number',
                ticksuffix: "Mhz",
                gridcolor: grid_color,
                range: [0, 3],
                domain: [0.26, 0.49]
            },
            /*********** SUBPLOT 4 ***************/
            yaxis4: {
                title: {text: 'Fan Speed'},
                type: 'number',
                ticksuffix: "%",
                gridcolor: grid_color,
                range: [0, 100],
                domain: [0, 0.24]
            },
            margin: {
                l: 100,
                r: 50,
                b: 50,
                t: 50,
                pad: 5
            },
            title: false,
            font: {color: text_color},
            plot_bgcolor: graph_color,
            paper_bgcolor: bg_color

        };

        Plotly.newPlot('myDiv', traces, layout, {responsive: true});


        /* colorway: [
             'rgba(255,0,200,0.52)',
             'rgba(149,0,255,0.52)',
             'rgba(0,34,255,0.52)',
             'rgba(38,255,0,0.52)',
             'rgba(255,213,0,0.52)',
             'rgba(255,0,0,0.52)',
             'rgba(98,180,79,0.52)',
             'rgba(213,115,220,0.52)',
*/


        myDiv.on('plotly_relayout', function (eventdata) {
            if (eventdata.custom) {
                return;
            } else if (new Date(eventdata["xaxis.range[0]"]).getTime() > 0 || eventdata["xaxis.autorange"]) {
                autoScroll = false;
            } else {
                autoScroll = true;
            }
        });


    };
    requestHistory.send()


    /************** REQUEST DATA UPDATE **************/
    let requestLast = new XMLHttpRequest();
    requestLast.responseType = 'json';
    requestLast.onload = function () {
        var data = requestLast.response

        /***** CALCULATE SCROLLING VIEW *****/
        if (autoScroll) {
            var time1 = new Date(data.Time)
            var time2 = new Date(data.Time)
            time2.setMinutes(time1.getMinutes() - 2);
            var minuteView = {
                custom: true,
                xaxis: {
                    gridcolor: grid_color,
                    anchor: 'free',
                    position: '1',
                    type: 'date',
                    range: [time2, time1]
                },

            };
            Plotly.relayout('myDiv', minuteView);
        }

        /******** ADD NEW DATAPOINTS ********/
        var newY = []
        var newX = []
        var indices = []
        var i = 0;
        for (var key in data) {
            if (key == "Time") continue;
            newY[i] = [parseInput(key, data)]
            newX[i] = [parseInput("Time", data)]
            indices[i] = i++
        }
        console.log(data)
        console.log(newY)

        Plotly.extendTraces('myDiv', {
            y: newY,    //[[data.Thermal0 / 1000], [data.Freq0]],
            x: newX     //[[time1], [time1]]

        }, indices)
    };


    setInterval(function () {
        requestLast.open('GET', window.location.href + "last");
        requestLast.send()
    }, 100);


    function parseInput(key, item) {
        item = item[key]
        if (key.includes("Thermal"))
            return item / 1000;
        else if (key.includes("Fan"))
            return item / 255.0 * 100.0
        else if (key.includes("FreqGpu"))
            return item / 1000000.0
        else if (key.includes("Freq"))
            return item / 1000000.0
        else if (key.includes("Time"))
            return new Date(item)
        else
            return item
    }

</script>

</body>
</html>