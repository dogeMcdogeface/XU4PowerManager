<head>
    <!-- Load plotly.js into the DOM -->
    <script src='https://cdn.plot.ly/plotly-2.4.2.min.js'></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        .full-height {
            height: 100%;
            background: yellow;
        }
    </style>
</head>

<body>
<div class="full-height" , id='myDiv'><!-- Plotly chart will be drawn inside this DIV --></div>

<script>


    var autoScroll = true;


    /************** REQUEST HISTORY ******************/
    let requestHistory = new XMLHttpRequest();
    requestHistory.responseType = 'json';
    requestHistory.open('GET', window.location.href + "history");
    requestHistory.onload = function () {
        console.log(requestHistory.response)

        /************** CREATE PLOT **********************/
        var history = requestHistory.response

        if (history.includes(null)) {
            setTimeout(function () {
                location.reload();
            }, 1000);
            return;
        }

        history.sort((a, b) => new Date(a.Time).getTime() - new Date(b.Time).getTime());


        var flippedData = {};
        for (var key in history[0]) {
            if (flippedData[key] == null) flippedData[key] = [];
        }
        for (var row in history) {
            for (var key in history[row]) {
                flippedData[key][row] = parseInput(key, history[row][key]);
            }
        }

        function parseInput(key, item) {
            if (key.includes("Thermal"))
                return item / 1000;
            else if (key.includes("Fan"))
                return item / 255.0 * 100.0
            else if (key.includes("Freq"))
                return item
            else
                return item
        }


        var traces = [];

        var i = 0;
        for (var key in flippedData) {
            var xa
            var ya;
            var cl;

            if (key == "Time")
                continue;
            else if (key.includes("Thermal")) {
                xa = 'x1';
                ya = 'y1';
            } else if (key.includes("Freq")) {
                xa = 'x2';
                ya = 'y2';
            } else if (key.includes("Fan")) {
                xa = 'x1';
                ya = 'y1';
            }

            traces[i++] = {
                name: key,
                y: flippedData[key],
                x: flippedData["Time"],
                xaxis: xa,
                yaxis: ya,
                mode: 'lines',
                //line: {color: '#80CAF6'}
            }
        }

        console.log("flippedData", flippedData)
        console.log("traces", traces)


        /*var timetable = history.map(function (item) {
            return new Date(item.Time);
        });
        var Thermal0 = history.map(function (item) {
            return item.Thermal0 / 1000;
        });
        var Freq0 = history.map(function (item) {
            return item.Freq0;
        });

        traces = [{
            y: Thermal0,
            x: timetable,
            // xaxis: 'x1',
            yaxis: 'y1',
            mode: 'lines',
            line: {color: '#80CAF6'}
        }, {
            y: Freq0,
            x: timetable,
            //xaxis: 'x2',
            yaxis: 'y2',
            mode: 'lines',
            line: {color: '#DF56F1'}
        }]*/


        Plotly.newPlot('myDiv', traces,
            {
                /*********** SUBPLOT 1 ***************/
                xaxis: {
                    anchor: 'x1',
                    type: 'date',
                    range: [-1, -1],
                    domain: [0, 1]
                },
                yaxis: {
                    anchor: 'y1',
                    type: 'number',
                    range: [0, 100],
                    domain: [0.6, 1]
                },
                /*********** SUBPLOT 2 ***************/
                /* xaxis2: {
                     anchor: 'y2',
                     type: 'date',
                     range: [-1, -1],
                     domain: [0, 1]
                 },*/
                yaxis2: {
                    anchor: 'x2',
                    type: 'number',
                    range: [0, 10000000],
                    domain: [0, 0.5]
                }
            }, {responsive: true}
        );


        myDiv.on('plotly_relayout', function (eventdata) {
            if (eventdata.custom) {
                return;
            } else if (new Date(eventdata["xaxis.range[0]"]).getTime() > 0 || eventdata["xaxis.autorange"]) {
                autoScroll = false;
            } else {
                autoScroll = true;
            }
        });


    };
    requestHistory.send()


    /************** REQUEST DATA UPDATE **************/
    let requestLast = new XMLHttpRequest();
    requestLast.responseType = 'json';
    requestLast.onload = function () {
        //console.log(requestLast.response)
        var data = requestLast.response
        var time1 = new Date(data.Time)
        var time2 = new Date(data.Time)
        time2.setMinutes(time1.getMinutes() - 2);


        var minuteView = {
            custom: true,
            xaxis: {
                type: 'date',
                range: [time2, time1]
            },
            xaxis2: {
                type: 'date',
                range: [time2, time1]
            }
        };

        if (autoScroll) {
            Plotly.relayout('myDiv', minuteView);
        }

        Plotly.extendTraces('myDiv', {
            y: [[data.Thermal0 / 1000], [data.Freq0]],
            x: [[time1], [time1]]

        }, [0, 1])


    };


    setInterval(function () {
        requestLast.open('GET', window.location.href + "last");
        requestLast.send()
    }, 100);


</script>

</body>
</html>